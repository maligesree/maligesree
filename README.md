DATA LB_TEST;
FORMAT ADT DATE9. ADY 8.;
SET LB_CAL;
IF LENGTH(LBDTC)>=10 THEN 
ADT=MDY(SUBSTR(LBDTC,6,2),SUBSTR(LBDTC,9,2),SUBSTR(LBDTC,1,4));
ELSE IF LENGTH(LBDTC)>=8 THEN 
ADT=MDY(SUBSTR(LBDTC,6,2),"01",SUBSTR(LBDTC,1,4));
IF ADT NE "" AND RFXSTDTC NE "" THEN DO;
TRTSTD=INPUT(RFXSTDTC,YYMMDD10.);
IF ADT LT TRTSTD THEN ADY=ADT-TRTSTD;
ELSE IF ADY=(ADT-TRTSTD)+1;
END;
RUN;
/* *********************************** */
DATA TEST;
INPUT SUBJECT GENDER $ TRT $;
CARDS;
101 M PLB
102 F PLB
202 F AT1
203 M PLB
301 M PLB
302 F AT1
;
RUN;
PROC FORMAT;
VALUE $TR 
'PLB'='PLACEBO'
 'AT1'='ACTIVE DRUG1'
 'AT2'='ACTIVE DRUG2';
 VALUE $GE
 'M'='MALE'
 'F'='FEMALE'
  'U'='UNDEFINED';
 RUN;
 
 PROC FREQ DATA=TEST;
 TABLES TRT*GENDER /OUT =COUNT (DROP=PERCENT);
 FORMAT TRT $TR. GENDER $GE.;
 RUN;
/* SPARCE */
 PROC FREQ DATA=TEST;
 TABLES TRT*GENDER / SPARSE OUT =COUNT1 (DROP=PERCENT);
 FORMAT TRT $TR. GENDER $GE.;
 RUN;

OPTION MISSING=0;
PROC TABULATE DATA=TEST OUT=COUNT3 (DROP=_TYPE_ _PAGE_ _TABLE_) ;
CLASS TRT GENDER/PRELOADFMT;
FORMAT TRT $TR. GENDER $GE.;
TABLE TRT*GENDER/PRINTMISS;
RUN;

/* HOW WE CAN MERGE WITH SUUPLAMENTRAY DATA SET TO MAIN DATA SET */
libname sdtm "/home/u61546083/SDTM_DATA";
DATA SUPPLB1;
SET SDTM.SUPPLB;
RUN;
PROC SORT DATA=SUPPLB1 OUT=SUPPLB2;
BY USUBJID IDVARVAL QNAM;
RUN;
/* CHARACTER TO NUMERIC */
DATA SUPPLB3;
SET SUPPLB2;
LBSEQ=INPUT(IDVARVAL,BEST12.);
RUN;
PROC SORT DATA=SUPPLB3;
BY USUBJID LBSEQ;
RUN; 
/* TRANSOSE THE DATA */
 PROC TRANSPOSE DATA=SUPPLB3 OUT=SUP_LB(DROP=_NAME_ _LABEL_) ;
 BY USUBJID LBSEQ;
 ID QNAM;
 VAR QVAL;
 RUN;
 
 PROC SORT DATA=SUP_LB;
BY USUBJID LBSEQ;
RUN; 
PROC SORT DATA=SDTM.SDTM_LB OUT=LB;
BY USUBJID LBSEQ;
RUN;
/*  MERGE MAIN DOMAIN WITH SUUP DOMAIN */

DATA MAIN_LB;
MERGE LB(IN=A) SUP_LB;
IF A;
BY USUBJID LBSEQ;
RUN;

/* BYVAL AND BYVAR OPTION IN PROC REPORT */
PROC SORT DATA=SASHELP.CLASS OUT=TEMP;
BY SEX;
RUN;
OPTIONS NOBYLINE CENTER NONUMBER NODATE;
TITLE1 'LISITING OF SUBJECT OF CHARCTERSTICS';
TITLE2 'SEX=#BYVAL(SEX)';
PROC REPORT NOWD DATA=TEMP ;
BY SEX;
COLUMN NAME HEIGHT WEIGHT;
DEFINE NAME/'PATIENT NAME' WIDTH=30;
DEFINE HEIGHT/'HEIGHT' WIDTH=15;
DEFINE WEIGHT/'WEIGHT' WIDTH=15;
RUN;






/* BYVAL AND BYVAR OPTION IN PROC REPORT */
PROC SORT DATA=SASHELP.CLASS OUT=TEMP;
BY SEX AGE;
RUN;
OPTIONS NOBYLINE CENTER NONUMBER NODATE;
TITLE1 'LISITING OF SUBJECT OF CHARCTERSTICS';
TITLE2 'SEX=#BYVAL1 , AGE=#BYVAL2';
PROC REPORT NOWD DATA=TEMP ;
BY SEX AGE;
COLUMN NAME HEIGHT WEIGHT;
DEFINE NAME/'PATIENT NAME' WIDTH=30;
DEFINE HEIGHT/'HEIGHT' WIDTH=15;
DEFINE WEIGHT/'WEIGHT' WIDTH=15;
RUN;

PROC FORMAT ;
VALUE AGEGRP
1-12='ELEMENTRY SCHOOL'
13-14='MIDLE SCHOOL'
OTHER='HIGH SCHOOL';
RUN;



PROC SORT DATA=SASHELP.CLASS OUT=TEMP;
BY  AGE;
FORMAT AGE AGEGRP.;
RUN;
OPTIONS NOBYLINE CENTER NONUMBER NODATE;
TITLE1 'LISITING OF SUBJECT OF CHARCTERSTICS';
TITLE2 '#BYVAR1=#BYVAL1';
PROC REPORT NOWD DATA=TEMP MISSING;
BY AGE;
COLUMN NAME HEIGHT WEIGHT;
DEFINE NAME/'PATIENT NAME' WIDTH=30;
DEFINE HEIGHT/'HEIGHT' WIDTH=15;
DEFINE WEIGHT/'WEIGHT' WIDTH=15;
RUN;





DATA TEMP;
SET SASHELP.CLASS;
DO VISIT=1 TO 4;
IF TRIM(LEFT(UPCASE(SEX)))='M' THEN WEIGHT=WEIGHT+VISIT;
OUTPUT;
END;
RUN;

PROC SORT DATA=TEMP;
BY VISIT;
RUN;

OPTIONS NOBYLINE CENTER NONUMBER NODATE;
TITLE1 'LISITING OF SUBJECT OF CHARCTERSTICS';
TITLE2 'VISIT=#BYVAL(VISIT)';
PROC REPORT NOWD DATA=TEMP HEADLINE;
BY VISIT;
COLUMN VISIT NAME WEIGHT;
DEFINE VISIT/ ORDER NOPRINT;
DEFINE NAME/'NAME' WIDTH=15;
DEFINE WEIGHT/'WEIGHT' WIDTH=15;
BREAK BEFORE VISIT/PAGE;
COMPUTE BEFORE _PAGE_;
LINE@1  "VISIT=" VISIT 1. J=R;
LINE "";
ENDCOMP;
RUN;


/* PAGE 13 BREAK AFTER */
PROC SORT DATA=LB;
BY USUBJID LBTEST LBTESTCD VISITNUM VISIT;
RUN;
DATA FINAL;
SET LB;
BY USUBJID LBTEST LBTESTCD VISITNUM VISIT;
RETAIN LNT PAGE 0;
LNT+1;
IF LNT>13 AND FIRST.LBTESTCD THEN DO;
PAGE=PAGE+1;
LNT=1;
END;
RUN;
PROC REPORT DATA=FINAL SPLIT='-' HEADLINE HEADSKIP NOWD NOWINDOWS;
COLUMN PAGE USUBJID LBTEST LBTESTCD VISITNUM VISIT LBDTC LBORRES LBSTRESC LBNRIND;
DEFINE PAGE/ ORDER  NOPRINT;
DEFINE USUBJID/ ORDER 'SUBJECT - NUMBER';
DEFINE LBTESTCD/ ORDER NOPRINT;
DEFINE LBTEST / ORDER 'TEST';
DEFINE VISITNUM / ORDER NOPRINT;
DEFINE VISIT/ORDER 'VISIT';
DEFINE LBDTC /DISPLAY 'DATE OF COLLECTION';
DEFINE LBORRES/DISPLAY 'ORIGINAL RESULTS';
DEFINE LBSTRESC/ DISPLAY 'STANDARD RESULTS';
DEFINE LBNRIND/DISPLAY 'FLAG';
BREAK AFTER PAGE/PAGE;
RUN;
/* HOW WE CAN COUNT 0 OBSERVATION IN DATA SET */
PROC SQL NOPRINT;
SELECT COUNT(*) INTO:N_OBS FROM SASHELP.CLASS
WHERE SEX=UPCASE("U");
QUIT;
%PUT &N_OBS;
%PUT &N_OBS.;

%MACRO REP();
%IF &N_OBS=0  %THEN %DO;
DATA NOOBS;
TXT = "NO OBSERVATION";
RUN;
PROC REPORT DATA=NOOBS;
COLUMN TXT;
DEFINE TXT/ ' ';
TITLE1 'GENDER OF THE SUBJECTS';
RUN;
%END;
%ELSE %DO;
PROC REPORT DATA=SASHELP.CLASS;
COLUMN NAME AGE;
TITLE1 'GENDER OF THE SUBJECTS';
RUN;
%END;
QUIT;
%MEND REP;

%REP();

/* HOW MANY WAYS TO CREATE MACROS AND DEBUGING */

/* 1 ST WAY TO CREATE A MACRO VARIBLE */
%LET DSN=CLINICAL;
%PUT &DSN;

PROC SORT DATA=SASHELP.CLASS OUT=&DSN;
BY AGE SEX;
RUN;


/* 2 POSTIONAL PARAMETER */
%MACRO LOOK (DSN,OBS);
PROC SOR DATA=&DSN ;
BY AGE;
RUN;
TITLE 'FIRST &OBS OBSERVATIONS';
RUN;
%LOOK(CLINICAL,10);
PROC SQL NOPRINT;
SELECT COUNT(NAME) INTO : NUM 
FROM SASHELP.CLASS;
QUIT;
%PUT &NUM;

PROC SQL NOPRINT;
SELECT COUNT(*) INTO : OBS
FROM SASHELP.CLASS;
QUIT;
%PUT &OBS;

PROC SQL NOPRINT;
SELECT COUNT(SEX) INTO : GENDER
FROM SASHELP.CLASS;
QUIT;
%PUT &GENDER;

PROC SQL NOPRINT;
SELECT DISTINCT NAME
INTO :VAR1 -:VAR19
FROM SASHELP.CLASS;
QUIT;
%PUT &VAR1 &VAR2 &VAR19;

DATA _NULL_;
SET SASHELP.CLASS;
CNT=LEFT(PUT(_n_,6.));
CALL SYMPUT('VAR'||CNT,NAME);
CALL SYMPUT('VARCNT',CNT);
RUN;

%PUT  &VAR2  &VAR15 &VAR10 &VAR12  &VAR19;
%PUT &VARCNT;

/* MACRO DEBUGING OPTIONS */
OPTIONS MPRINT SYMBOLGEN MLOGIC;
%MACRO txt;
DATA ONE;
 %DO i= 1 %to 10;
   t&i=&i;
 %end;
 run;
 %mend txt;
 %txt;
 
 
/* ANALYSIS BASE LINE VALUE CACULATION */
libname sdtm "/home/u61546083/SDTM_DATA";
/* read sdtm.LB */
DATA LB LB1(KEEP=STUDYID DOMAIN USUBJID SUBJID LBDTC );
SET SDTM.SDTM_LB;
RUN;
PROC SORT DATA=SDTM.SDTM_LB OUT=LB1;
BY USUBJID LBCAT LBTESTCD DESCENDING LBDTC;
RUN;
PROC SORT DATA =SDTM.SDTM_DM OUT=DM(KEEP=USUBJID RFSTDTC RFXSTDTC RFENDTC);
BY USUBJID;
RUN;

DATA LB2;
SET LB1;
LBDT=INPUT(LBDTC,YYMMDD10.);
AVAL=INPUT(LBORRES ,BEST12.);
BY USUBJID LBCAT LBTESTCD DESCENDING LBDTC;
RETAIN FLAG ;
IF FIRST.LBTESTCD THEN FLAG=0;
RUN;
DATA DM1;
SET DM;
TRTSDT=INPUT(RFXSTDTC,YYMMDD10.);
RUN;
DATA LB3;
MERGE  LB2 DM1;
BY USUBJID;
IF FLAG =0 AND LBDT <= TRTSDT AND AVAL NE . THEN DO;
ABLFL='Y';
FLAG=1;
END;
RUN;

PROC SORT DATA=SDTM.SDTM_LB OUT=LB1;
BY USUBJID LBCAT LBTESTCD  LBDTC;
RUN;
 DATA LB2;
 SET LB1;
BY USUBJID LBCAT LBTESTCD  LBDTC;
RETAIN BASE;
IF FIRST.LBTESTCD THEN BASE=.;
IF LBBLFL='Y' THEN BASE=LBORRES;
ELSE DO;
CHG=LBORRES-BASE;
PCHG=((LBORRES-BASE)/BASE)*100;
END;
RUN;

DATA LABB;
INPUT ARAMN PARAM $ 3-25 PARAMCD $ 26-31  ATYPE $ 34-38  LBCAT $ 40-50 LBTESTCD $ 51-57;
CARDS;
1 Potassium (mmol/L)     K       num   CHEMISTRY  K
2 Albumin (g/L)          ALB     num   CHEMISTRY  ALB
3 Creatinine (umol/L)    CREAT   num   CHEMISTRY  CREAT
4 Basophils (10^9/L)     BASO    num   HEMATOLOGY BASO
5 Prothrombin Time (sec) PT      num   HEMATOLOGY PT
6 Color                  COLOR   char  URINALYSIS COLOR
7 pH                     PH      num   URINALYSIS PH
8 Protein                PROT    char  URINALYSIS PROT
;
RUN;
proc sort data=LABB out=lblookup;
 by LBCAT LBTESTCD;
run;
proc sort data=SDTM.SDTM_LB out=lb;
 by LBCAT LBTESTCD;
run;
data lbparams;
 merge lb (in=inlb) lblookup (in=inlookup);
 by LBCAT LBTESTCD;
 if inlb and inlookup;
run;
/* Deriving Analysis Date and Analysis Study Day */

PROC SORT DATA=LBPARAMS OUT=PARMS;
BY USUBJID;
RUN;

PROC SORT DATA =SDTM.SDTM_DM OUT=DM(KEEP=USUBJID RFSTDTC RFXSTDTC RFENDTC);
BY USUBJID;
RUN;
DATA PARMS;
MERGE PARMS(IN=A) DM;
BY USUBJID;
IF A;
RUN;
DATA PARAMS1;
SET PARMS;
TRTSDT=INPUT(RFXSTDTC,YYMMDD10.);
LBDT=INPUT(LBDTC,YYMMDD10.);
RUN;
DATA PARM_ADT;
SET PARAMS1;
 format ADT date9.;
 if length(LBDTC) >= 10 then
 ADT = mdy(substr(LBDTC,6,2), substr(LBDTC,9,2), substr(LBDTC,1,4));
 format ADY 8.;
 if ADT > . and TRTSDT > . then do;
 if ADT < TRTSDT then ADY = ADT - TRTSDT;
 else ADY = ADT - TRTSDT + 1;
 end;
/*  Determining Baseline */
format ABLFL $1.;
 if ADY = 1 then ABLFL = 'Y';
 else ABLFL = '';
 
/*  Deriving Analysis Visits */
 format AVISITN 8.;
 format AVISIT $15.;
 if ABLFL='Y' then do; AVISITN = 1; AVISIT='Baseline'; end;
 else if .< ADY<= 1 then do; AVISITN = 0; AVISIT='Pre-Treatment'; end;
 else if 21<=ADY<=35 then do; AVISITN = 4; AVISIT='Week 4'; end;
 else if 49<=ADY<=63 then do; AVISITN = 8; AVISIT='Week 8'; end;
 else if 77<=ADY<=91 then do; AVISITN = 12; AVISIT='Week 12'; end;
 else if 92<=ADY then do; AVISITN = 99; AVISIT='Post-Week 12'; end;
 RUN;
